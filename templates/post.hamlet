<div class="#{pClass} row"  id=#{pId}>
  <!-- Post header -->
  <div .post-header .row>
    <div .columns .large-12>
      <input .mark-to-delete type=checkbox name=postdelete value=#{sPostKey}>
      <i title=_{MsgEditIcon} onclick="showEditForm('#{pId}',#{sPostKey})"  .icon-edit-post .fa .fa-edit>
      $maybe (code, name) <- lookup (entityKey ePost) geoIps
          <img src=#{geoIconPath code} title=#{name}>
      <span .post-title>#{postTitle postVal}
      <span .poster-name>#{postName postVal}
      $if showPostDate
          <span .time>#{myFormatTime tOffset $ postDate postVal}
      $if isThread
        $if not inThread
           <i onclick="hideThread(#{sPostId},'#{board}')"  title=_{MsgHideThread} .icon-hide-thread .fa .fa-minus> 
           <i onclick="hideThreadCompletely(#{sPostId},'#{board}')"  title=_{MsgHideThreadCompletely} .icon-hide-thread-completely .fa .fa-eye-slash>
      <span .thread-status>
          $if postSticked postVal
              <i title=_{MsgThreadIsSticked} .fa .fa-caret-down>
          $if postLocked postVal
              <i  title=_{MsgThreadIsLocked} .fa .fa-lock>
          $if postAutosage postVal
              <i  title=_{MsgThreadAutosage} .fa .fa-angle-double-down>
      <span .reflink>
          $if isThread
              <a onclick=highlightPost('#{pId}') href=@{ThreadR board (read sPostId)}##{sPostId}>No.
          $else
              <a onclick=highlightPost('#{pId}') href=@{ThreadR board (read sThreadId)}##{sPostId}>No.
          <a onclick="insert('>>#{sPostId}#{pack "\\n"}')">#{sPostId}

      $if showParent
        $if isThread
          <a .parent-link href=@{BoardNoPageR board}>>>/#{board}/
        $else
          <a .parent-link onmouseover="timeout(this,function(){showPopupPost(event,this,'#{board}',#{sThreadId});},700)" onclick="highlightPost('#{pId}')" href=@{ThreadR board (read sThreadId)}>>>/#{board}/#{sThreadId}

      <!-- Moderation -->
      $if elem ManageBanP permissions
        <a href=@{BanByIpR board (postIp postVal)}>
          <i title="_{MsgBanPoster}"  .fa .fa-gavel>

      $if elem ManageThreadP permissions
        $if isThread
          <i title="_{MsgMoveThread}" onclick="moveThread('#{board}', #{sPostId})"  .fa .fa-arrows> 
          <i title="_{MsgManageThread}" data-dropdown="manage-thread-#{sPostId}"  .fa .fa-cog>
          <ul id="manage-thread-#{sPostId}" .f-dropdown>
            <li>
              <a href=@{StickR board (postLocalId postVal)}>_{MsgStickThread}
            <li>
              <a href=@{LockR  board (postLocalId postVal)}>_{MsgLockThread} 
            <li>
              <a href=@{AutoSageR board (postLocalId postVal)}>_{MsgAutosage}

      $if elem HellBanP permissions
          <i title="_{MsgHellbanning}" data-dropdown="manage-hellban-#{sPostId}" .fa .fa-shield>
          <ul id="manage-hellban-#{sPostId}" .f-dropdown>
            <li>
              <a  href=@{HellBanDoR (read sPostKey) "none" True}>_{MsgHellbanPoster}
            <li>
              <a  href=@{HellBanDoR (read sPostKey) "one" True}>_{MsgHideAndHellban}
            <li>
              <a href=@{HellBanDoR (read sPostKey) "one" False}>_{MsgHellbanHide} 
            <li>
              <a href=@{HellBanDoR (read sPostKey) "all" True}>_{MsgHideAllAndHellban} 
            <li>
              <a href=@{HellBanUndoR (read sPostKey) "show"}>_{MsgHellbanShowPost} 
            <li>
              <a href=@{HellBanUndoR (read sPostKey) "both"}>_{MsgHellbanShowAndUnban} 
            <li>
              <a href=@{HellBanUndoR (read sPostKey) "unban"}>_{MsgHellbanUnbanUser} 
          $if postHellbanned postVal
              <i title=_{MsgPostIsVisibleOnlyForAuthor} .fa .fa-eye>
      <!-- End of moderation -->
      $if canPost
          <i title=_{MsgReplyIcon} onclick="showQuickPostForm('#{pId}');insert('>>#{sPostId}#{pack "\\n"}');" .icon-reply .fa .fa-toggle-right>

      $if isThread
        $if not inThread
          <a href=@{ThreadR board $ postLocalId postVal}>_{MsgOpenThread}
    $if elem ViewIPAndIDP permissions
        <div .columns .large-12>
          <span .ip-and-id>
              IP:
              <a title="_{MsgAdminSearchIP}" href=@{AdminSearchIPNoPageR (postIp postVal)}>
                #{postIp postVal}
              UID:
              <a title="_{MsgAdminSearchUID}" href=@{AdminSearchUIDNoPageR (postPosterId postVal)}>
                #{postPosterId postVal}
  <!-- End of post header -->
  <div .row>      
   <div .columns .large-12>
    <!-- Post files -->
    $forall Entity fileKey file <- eFiles
      $with c <- ifelse (length eFiles == 1) "file" "multi-file"
        $with fId <- show $ int64ToInt $ fromKey fileKey
          <div class=#{c} id="file-#{fId}">
            $with ratingF <- attachedfileRating file
              <span .file-name>
                  <a title=#{attachedfileOrigName file} target=_blank href=#{imageUrlPath (attachedfileType file) (attachedfileName file)}>#{truncateFileName maxLenOfFileName $ attachedfileOrigName file}

              $if elem ChangeFileRatingP permissions
                $with rating1 <- read $ unpack ratingF
                  <a data-dropdown="manage-rating-#{fId}" .button .dropdown .tiny .secondary>#{show rating1}
                  <ul id="manage-rating-#{fId}" .f-dropdown>
                    $if not (rating1 == SFW)
                      <li>
                        <a href=@{ManageCensorshipR (fromIntegral $ fromKey fileKey) SFW}>SFW
                    $if not (rating1 == R15)
                      <li>
                        <a href=@{ManageCensorshipR (fromIntegral $ fromKey fileKey) R15}>R-15
                    $if not (rating1 == R18)
                      <li>
                        <a href=@{ManageCensorshipR (fromIntegral $ fromKey fileKey) R18}>R-18
                    $if not (rating1 == R18G)
                      <li>
                        <a href=@{ManageCensorshipR (fromIntegral $ fromKey fileKey) R18G}>R-18G

              $if isImageFile (attachedfileType file)
                  <div .file-info> #{attachedfileType file}, #{attachedfileSize file}, #{attachedfileWidth file}x#{attachedfileHeight file}
              $else
                  <div .file-info> #{attachedfileType file}, #{attachedfileSize file}
              $if checkRating ratingF rating
                <a .thumb onclick="return expandImage(this, event)" title=#{attachedfileOrigName file} target=_blank href=#{imageUrlPath (attachedfileType file) (attachedfileName file)}>
                  $if attachedfileThumbWidth file == -1
                      <img alt=#{attachedfileName file} src="#{thumbUrlPath (attachedfileThumbSize file) (attachedfileType file) (attachedfileName file)}">
                  $elseif isImageFile (attachedfileType file)
                      <img img-width=#{attachedfileWidth file} img-height=#{attachedfileHeight file} title="#{attachedfileType file}, #{attachedfileSize file}, #{attachedfileWidth file}x#{attachedfileHeight file}" alt=#{attachedfileName file} width=#{attachedfileThumbWidth file} height=#{attachedfileThumbHeight file} src="#{thumbUrlPath (attachedfileThumbSize file) (attachedfileType file) (attachedfileName file)}">
                  $else
                      <img title="#{attachedfileType file}, #{attachedfileSize file}" alt=#{attachedfileName file} src="#{thumbUrlPath (attachedfileThumbSize file) (attachedfileType file) (attachedfileName file)}">
              $else
                $case (read $ unpack ratingF)
                  $of R15
                    <img alt=R-15 src="@{StaticR img_r15_png}" width=#{attachedfileThumbSize file} .censored>
                  $of R18
                    <img alt=R-18 src="@{StaticR img_r18_png}" width=#{attachedfileThumbSize file} .censored>
                  $of R18G
                    <img alt=R-18G src="@{StaticR img_r18g_png}" width=#{attachedfileThumbSize file} .censored>
                  $of SFW
                    Suppress warnings.
    <!-- End of post files -->
    <!-- Message -->
    $with m <- unTextarea $ postMessage postVal
        $if checkAbbr (T.length m) inThread
            <div .message .abbreviated>#{preEscapedToHtml m}
            <div .expand-post>
                _{MsgPostMessageIsTooLong}
                <a onclick="expandPost('#{pId}');">_{MsgExpandPost}
            <div .hide .shrink-post>
                <a onclick="shrinkPost('#{pId}');">_{MsgShrinkPost}
        $else
            <div .message>#{preEscapedToHtml m}
    <!-- Last modified -->
    $if showEditHistory
      $maybe lm <- postLastModified postVal
        <span .last-modified>
            <a href=@{EditHistoryR $ fromIntegral $ fromKey $ entityKey ePost}>
                _{MsgLastModified}
                <span .last-modified-date>#{myFormatTime tOffset lm}
      $nothing
        <span .last-modified .hide>
            <a href=@{EditHistoryR $ fromIntegral $ fromKey $ entityKey ePost}>
                _{MsgLastModified}
                <span .last-modified-date> 
